/**
 * Bundle Lambda handlers with esbuild
 */

import * as esbuild from 'esbuild';
import * as fs from 'fs';
import * as path from 'path';

const HANDLERS_DIR = 'src';
const OUTPUT_DIR = 'dist';

// Find all handler files
const handlers = fs
  .readdirSync(HANDLERS_DIR)
  .filter((dir) => {
    const handlerPath = path.join(HANDLERS_DIR, dir, 'handler.ts');
    return fs.existsSync(handlerPath);
  })
  .map((dir) => ({
    name: dir,
    entry: path.join(HANDLERS_DIR, dir, 'handler.ts'),
    outfile: path.join(OUTPUT_DIR, dir, 'handler.js'),
  }));

console.log(`Bundling ${handlers.length} Lambda handlers...`);

// Bundle each handler
for (const handler of handlers) {
  await esbuild.build({
    entryPoints: [handler.entry],
    bundle: true,
    platform: 'node',
    target: 'node20',
    format: 'esm',
    outfile: handler.outfile,
    external: [
      '@aws-sdk/*', // Use Lambda's built-in AWS SDK
    ],
    sourcemap: true,
    minify: process.env.NODE_ENV === 'production',
    banner: {
      js: '// Generated by esbuild',
    },
  });

  console.log(`  âœ“ ${handler.name}`);
}

console.log('Done!');
