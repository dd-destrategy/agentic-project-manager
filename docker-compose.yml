version: '3.8'

services:
  # DynamoDB Local for development
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: agentic-pm-dynamodb
    ports:
      - '8000:8000'
    command: '-jar DynamoDBLocal.jar -sharedDb -dbPath /data'
    volumes:
      - dynamodb-data:/data
    healthcheck:
      test: ['CMD-SHELL', 'curl -s http://localhost:8000/shell/ || exit 1']
      interval: 10s
      timeout: 5s
      retries: 3

  # DynamoDB Admin UI (connects to LocalStack DynamoDB)
  dynamodb-admin:
    image: aaronshaf/dynamodb-admin:latest
    container_name: agentic-pm-dynamodb-admin
    ports:
      - '8001:8001'
    environment:
      - DYNAMO_ENDPOINT=http://localstack:4566
      - AWS_REGION=ap-southeast-2
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
    depends_on:
      - localstack

  # LocalStack for other AWS services (SES, Secrets Manager)
  localstack:
    image: localstack/localstack:latest
    container_name: agentic-pm-localstack
    ports:
      - '4566:4566'
    environment:
      - SERVICES=dynamodb,ses,secretsmanager
      - DEBUG=0
      - DATA_DIR=/var/lib/localstack/data
    volumes:
      - localstack-data:/var/lib/localstack
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:4566/_localstack/health']
      interval: 10s
      timeout: 5s
      retries: 3

  # MailHog for email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: agentic-pm-mailhog
    ports:
      - '1025:1025' # SMTP
      - '8025:8025' # Web UI

volumes:
  dynamodb-data:
  localstack-data:
